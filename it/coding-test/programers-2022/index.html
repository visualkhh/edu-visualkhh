<html>
<head>
    <title>2022 FE 데브매칭</title>
    <link rel="stylesheet" href="./style.css">
</head>
<script src="node_modules/dom-render/dist/bundle.js"></script>
<body>
<main id="app" class="App">
    <div dr-if="this.selectedLanguages && this.selectedLanguages.length > 0" class="SelectedLanguage">
        <ul>
            <li dr-for-of="this.selectedLanguages">${#it#}$</li>
        </ul>
    </div>
    <form class="SearchInput" dr-event-submit="$event.preventDefault();">
        <input dr-on-init="this.setSearchInputElement($element)" dr-value-link="this.changeKeyword" dr-event-keyup="this.keywordKeyUp($event)" class="SearchInput__input" type="text" placeholder="프로그램 언어를 입력하세요.">
    </form>
    <div dr-if="this.displayLanguage.items.length > 0" class="Suggestion">
        <ul>
            <li dr-for-of="this.displayLanguage.items" dr-class="{'Suggestion__item--selected': #nearForOfIndex# === this.displayLanguage.selectedIndex}" dr-event-click="this.pushSelectedLanguages(#nearForOfIndex#);">
                #{this.displaySearchLanguageList(#it#)}#
            </li>
        </ul>
    </div>
</main>
<script src="node_modules/rxjs/dist/bundles/rxjs.umd.js"></script>
<script type="module" src="src/api-service.js"></script>
<script type="module">
    import apiService from "./src/api-service.js";
    // import { concat, merge, Subject } from 'rxjs';
    const target = document.querySelector('#app');

    class App {
        catch = DomRenderFinalProxy.final(new Map());
        keyWordSubject = DomRenderFinalProxy.final(new rxjs.Subject());
        selectedLanguages = [];
        displayLanguage = {
            items: [],
            selectedIndex: 0,
            prevIndex: () => {
                this.displayLanguage.selectedIndex++;
                if (this.displayLanguage.selectedIndex >= this.displayLanguage.items.length) {
                    this.displayLanguage.selectedIndex = 0;
                }
            },
            nextIndex: () => {
                this.displayLanguage.selectedIndex--;
                if (this.displayLanguage.selectedIndex < 0) {
                    this.displayLanguage.selectedIndex = this.displayLanguage.items.length - 1;
                }
            }
        };

        constructor(apiService) {
            this.apiService = apiService;
            this.keyWordSubject.pipe(
                rxjs.debounceTime(500),
                rxjs.distinctUntilChanged()
            ).subscribe(async (value) => {
                if (this.catch.has(value)) {
                    this.displayLanguage.items = this.catch.get(value);
                } else {
                    this.displayLanguage.items = value && value.length > 0 ? await this.apiService.getKeyword(value) : [];
                    this.catch.set(value, this.displayLanguage.items);
                }
                this.displayLanguage.selectedIndex = 0;
            });
        }

        setSearchInputElement(element) {
            element.focus()
            this.searchInputElement = element;
        }
        displaySearchLanguageList(data) {
            return data.replaceAll(this.searchInputElement.value, '<span class="Suggestion__item--matched">' + this.searchInputElement.value + '</span>');
        }
        keywordKeyUp(event) {
            // up
            if (event.keyCode === 40) {
                this.displayLanguage.prevIndex();
            } else if (event.keyCode === 38) {
                this.displayLanguage.nextIndex();
            } else if (event.keyCode === 13) {
                this.pushSelectedLanguages()
            }
        }


        pushSelectedLanguages(displayIndex = this.displayLanguage.selectedIndex, reset = true) {
            const selected = this.displayLanguage.items[displayIndex];
            alert(selected);
            const newSelectedLanguages = this.selectedLanguages.filter(it => it !== selected);
            newSelectedLanguages.push(selected);
            if(newSelectedLanguages.length > 5) {
                newSelectedLanguages.shift();
            }
            this.selectedLanguages = newSelectedLanguages;
            if (reset) {
                this.displayLanguage.items = [];
                this.displayLanguage.selectedIndex = 0;
                this.searchInputElement.value = '';
            }
        }
        async changeKeyword(value, event) {
            this.keyWordSubject.next(value);
        }
    }

    DomRender.run(new App(apiService), target);
</script>
</body>
</html>